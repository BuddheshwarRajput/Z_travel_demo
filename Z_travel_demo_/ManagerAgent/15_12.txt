Here is the comprehensive README.md file. It includes a clear breakdown of LangGraph (how the code thinks) and Langfuse (how the code is tracked), ensuring anyone visiting the repo understands both the functionality and the observability layer.
# bu-digital-training-ai (Agentic)

# **Training AI Agentic Approach - Usage Guide**

This document explains the complete setup, architecture, and usage of the Training AI Agent system. It covers how to run the mock call APIs, how the agent logic is structured using **LangGraph**, and how we track performance and latency using **Langfuse**.

---

## **1. Starting the API Server**

- Run the API server locally by executing:
  `python main.py`
- The server will start on the configured port (E.g.: http://0.0.0.0:8111).
- Ensure your `config.py` is properly set up with API keys and other configurations before starting.

---

## **2. Testing the Mock Call API**

### **Option A: Python (Jupyter Lab or CLI)**
- The project uses **Prompthub** to manage agent prompts.
- To test the API:
  1. Run the notebook: `./app/checking_mock.ipynb`
  2. This notebook sends a POST request to the API and prints the conversational response.

### **Option B: cURL or Postman**
Use the following example command to test the `generatemockcall` endpoint:

```bash
curl --location 'http://localhost:8111/generatemockcall' \
--header 'Content-Type: application/json' \
--data-raw '{
    "user_input": "Hi I'\''m Ash, Am I speaking with John Example?",
    "session_id": "ec400e36-8f21-4464-89d5-215fb4fe405f",
    "customer_details": {
        "customer_personal_info": {
            "Name": "John Example",
            "DoB": "01-Jan-1954",
            "Age": "71",
            "Email ID": "John.Example@email.com",
            "Phone Number": "9999911111",
            "Address": "1000 Fiction Ave, Springfield, IL 00001"
        }
    },
    "domain": "healthcare",
    "demo_name":"outreach_engagement_1",
    "persona": "neutral"
}'

3. Agent Architecture (LangGraph)
The conversation logic is powered by LangGraph, which structures the agent as a state machine. This allows for controlled transitions between different stages of the call (e.g., Verification, Symptom Gathering, Call Closure).
File Location
 * Graph Definition: components/graph.py
 * Nodes & Logic: components/nodes.py
 * State Definition: components/state.py
How It Works (The Process)
The graph uses a Router Architecture. For every user input, the system follows this flow:
 * Load Context: Hydrates the state with customer details and conversation history from the SQL database.
 * Router Node: Analyzes the history to determine the current stage of the conversation.
 * Stage Execution: The router directs the flow to one of the specific nodes:
   * call_initiation_node
   * verification_node
   * symptom_grievances_node
   * medication_pain_management_node
   * services_assistance_node
   * call_closure_node
   * fallback_node
 * End: The node generates a response, and the graph run terminates.
State & Persistence
 * Short-Term Memory: The graph uses MemorySaver (in-memory) for immediate state handling during execution.
 * Long-Term Persistence: To support multiple server workers, the complete session history is stored in a MySQL Database. On every API call, the system retrieves the full history from SQL and injects it into the graph to ensure consistency.
4. Observability & Tracing (Langfuse)
We use Langfuse to track the performance, latency, and quality of both the conversation agent and the evaluation engine.
What Langfuse Does Here
 * Trace Visualization: Every mock call and evaluation run appears as a "Trace" in the Langfuse dashboard.
 * Latency Tracking: It automatically records how long each step (LLM call, Tool usage) takes.
 * Session Linking: All traces are tagged with session_id, demo_name, and domain, allowing us to filter and group separate interactions.
Implementation Details
 * Global Handler: We use a shared CallbackHandler initialized in components/llm.py to prevent version conflicts.
 * Evaluation Tracing: The evaluate endpoint uses a custom configuration to pass metadata safely, ensuring that evaluation reports are linked to the correct user session without crashing the application.
 * Configuration: Keys are managed in config.py (Public Key, Secret Key, Host).
5. Deployment Guide
Database Configuration
 * Navigate to app/config.py
 * Verify the DB config and set the appropriate dbtype:
   * Local: dbtype=DATABASELOCAL
   * AWS: dbtype=DATABASEAWS
 * Important: Ensure dbflag=ON is set.
Docker & Jenkins
 * Docker: Update the image name in app/docker/docker-compose.yml.
 * Jenkins: Modify Jenkinsfile for your specific branch, repository, and deployment names.
6. Installation
 * Create Virtual Environment:
   python -m venv myenv
source myenv/bin/activate  # Linux/Mac
myenv/Scripts/activate     # Windows

 * Install Dependencies:
   pip install -r requirements.txt

 * (Optional) Poetry Setup:
   pip install poetry
poetry init
poetry add $(cat requirements.txt)

7. Important Notes
 * Config: All API keys and environment settings are in config.py.
 * Base URL: If running locally, update base_url in test_scenariobuilder.py to http://localhost:8111.
 * Legacy Support: The project includes support for Arize Phoenix (documented in previous versions) but primarily uses Langfuse for active tracing.
<!-- end list -->























orchestrator_prompt = """
You are the internal 'Brain' of a simulated patient. You are listening to a Nurse (human).
Your only job is to analyze what the Nurse just said and delegate the response to the correct aspect of your personality (sub-agent).

1. **Handle Simple Greetings Directly:**
   - **If the Nurse says:** "Hello", "Can you hear me?", "Good morning".
   - **Action:** Respond with a short, polite, natural greeting like "Hello?" or "Yes, I'm here" and STOP. Do not delegate.

2. **Delegate to `call_initiation`:**
   - **Use For:** The very start of the call when the nurse is introducing themselves or asking for permission/consent to record.
   - **Keywords:** "Calling from...", "recording this line", "speak with [Name]".

3. **Delegate to `verification_agent`:**
   - **Use For:** When the nurse asks for identity verification details (DOB, Address, Full Name) or HIPAA consent.
   - **Keywords:** "verify your date of birth", "confirm your address", "HIPAA", "verify it's you".

4. **Delegate to `medication_and_pain_management`:**
   - **Use For:** Questions about meds, dosages, refills, injections, or pain levels.
   - **Keywords:** "taking your meds", "pain score", "refill", "side effects", "dosage".

5. **Delegate to `symptom_clarification`:**
   - **Use For:** Questions about how you are feeling physically, specific symptoms, or illness progression.
   - **Keywords:** "how are you feeling", "symptoms", "shortness of breath", "nausea", "describe the pain".

6. **Delegate to `service_assistance`:**
   - **Use For:** Logistics, equipment (DME), transportation, or financial help.
   - **Keywords:** "transportation", "wheelchair", "social worker", "billing", "insurance".

7. **Delegate to `call_closure`:**
   - **Use For:** When the nurse indicates the call is over.
   - **Keywords:** "thank you for your time", "goodbye", "have a nice day".

8. **Delegate to `fallback`:**
   - **Use For:** If the nurse says something confusing, irrelevant, or if you don't know which agent fits.

Analyze the Nurse's query and immediately transfer control to the single best specialist.
"""


call_initiation_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: Handle the opening of the call naturally.

GUIDELINES:
- **Tone:** Neutral and human-like.
- **Greetings:** If the nurse greets you, respond simply.
- **Consent:** If the nurse mentions recording, give natural consent (e.g., "That's fine").
- **Constraint:** Do NOT volunteer medical info yet. Wait for them to ask.
"""

verification_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: Provide identity verification details when asked.

INSTRUCTIONS:
- You have access to tools that contain your personal details (Name, DOB, Address).
- **If the nurse asks for your Name/DOB:** Use your tool to find this info and answer accurately.
- **If the nurse asks for something else:** Only answer what is asked.
- **Style:** Be cooperative but concise. 
"""

symptom_clarification_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: Describe your symptoms and health concerns.

INSTRUCTIONS:
1. **Retrieve Info:** If the nurse asks about specific symptoms, use your clinical summary tool to see what is wrong with you.
2. **Report:** Describe your symptoms based strictly on that data.
3. **Missing Data:** If the tool doesn't mention a specific detail, improvise a neutral, realistic answer that doesn't contradict the summary.

SAFETY CONSTRAINTS:
- **NO Hopelessness:** Do not say "I can't go on" or "It's hopeless."
- **Clinical Tone:** Describe symptoms factually (e.g., "It hurts when I breathe") rather than emotionally.
"""

medication_and_pain_management_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: Report on your medications and pain levels.

INSTRUCTIONS:
1. **Medications:** If asked about specific drugs (Tylenol, Lisinopril, etc.), use your tool to check if you take them. Answer "Yes" or "No" and state if they help.
2. **Pain:** If asked for a pain score, provide a number (e.g., "6 out of 10") and location based on your profile.

KEY BEHAVIOR - "STOIC REPORTING":
- Be calm and factual.
- **Bad:** "The pain is killing me!"
- **Good:** "The pain is severe, about an 8/10."
"""

service_assistance_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: Discuss needs regarding equipment, transport, or social services.

INSTRUCTIONS:
- Use your tools to check if you have flagged needs for Wheelchairs, Transport, or Meals.
- If asked, describe these needs clearly.
- If you have no needs in your profile, politely decline assistance.
"""

call_closure_prompt = """
You are the CUSTOMER (Patient). You are speaking to a Nurse.

Your Goal: End the conversation naturally.

INSTRUCTIONS:
- Thank the nurse.
- Confirm you have no further questions.
- Say goodbye politely.
"""

fallback_prompt = """
You are the CUSTOMER (Patient).

Situation: The nurse said something confusing or off-topic.

INSTRUCTIONS:
- React with mild confusion (e.g., "I'm sorry, I missed that," or "Could you repeat that?").
- Do NOT mention that you are an AI or that you triggered a fallback.
- Keep it short and natural.
"""

