import os
import json
import boto3
import matplotlib
# CRITICAL: Switch backend to 'Agg' before importing pyplot.
# This prevents "TclError: no display name" crashes on headless servers (EKS/EC2).
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from datetime import datetime
from reportlab.lib.pagesizes import A4
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Image, Table, TableStyle
from botocore.exceptions import ClientError
from config import configuration

# ======================================================
# 1. Helper: Generate Chart (Thread-Safe)
# ======================================================
def generate_horizontal_bar_chart(categories_score, chart_path):
    """
    Generates a horizontal bar chart and saves it to the specified path.
    Uses a new figure instance to avoid thread contention.
    """
    categories = list(categories_score.keys())
    # Clean percentages (remove %) and convert to float
    scores = [float(v.replace('%', '')) for v in categories_score.values()]

    colors_list = [
        (0.2, 0.4, 1.0, 0.85) if s >= 80 else (1.0, 0.3, 0.3, 0.8)
        for s in scores
    ]

    # Create a specific figure object instead of using global plt instance
    fig, ax = plt.subplots(figsize=(10, 6))
    
    bars = ax.barh(categories, scores, color=colors_list, edgecolor='black')
    
    for i, bar in enumerate(bars):
        ax.text(bar.get_width() + 1, bar.get_y() + bar.get_height()/2, 
                f"{scores[i]}%", va='center', fontsize=10, color='black')
    
    ax.set_xlim(0, 100)
    ax.set_xlabel("Score (%)", fontsize=12)
    ax.set_title("Call Evaluation Analysis", fontsize=14, color='navy', pad=15)
    ax.invert_yaxis()
    ax.grid(axis="x", linestyle="--", alpha=0.4)
    
    plt.tight_layout()
    fig.savefig(chart_path, dpi=300)
    plt.close(fig) # Explicitly close to free memory

# ======================================================
# 2. Helper: Upload & Sign
# ======================================================
def upload_pdf_to_s3(local_file_path, s3_filename):
    """
    Uploads PDF to S3 using the IAM Role and generates a Presigned URL.
    Returns: (success: bool, url_or_error: str)
    """
    bucket_name = configuration['S3']['bucket_name']
    region = configuration['S3']['region']
    folder_prefix = configuration['S3']['folder_prefix']
    
    # Initialize Client with Region (Required for SigV4 Presigned URLs)
    # No keys needed - Boto3 automatically picks up the EKS/IAM Role.
    s3_client = boto3.client('s3', region_name=region)

    try:
        s3_key = f"{folder_prefix}{s3_filename}"
        
        # 1. Upload File
        s3_client.upload_file(
            local_file_path,
            bucket_name,
            s3_key,
            ExtraArgs={
                'ContentType': 'application/pdf',
                # Forces browser to download with specific filename
                'ContentDisposition': 'attachment' 
            }
        )
        
        # 2. Generate Presigned URL (Valid for 5 minutes / 300 seconds)
        presigned_url = s3_client.generate_presigned_url(
            'get_object',
            Params={'Bucket': bucket_name, 'Key': s3_key},
            ExpiresIn=300
        )
        
        print(f"[S3] Upload successful for {s3_filename}")
        return True, presigned_url

    except ClientError as e:
        error_msg = f"S3 ClientError: {str(e)}"
        print(f"[S3 ERROR] {error_msg}")
        return False, error_msg
    except Exception as e:
        error_msg = f"S3 Unexpected Error: {str(e)}"
        print(f"[S3 ERROR] {error_msg}")
        return False, error_msg

# ======================================================
# 3. Main Function: Generate Report
# ======================================================
def generate_pdf_report(json_evaluation, sid):
    """
    Orchestrates PDF creation, chart generation, and S3 upload.
    Handles cleanup of temporary files in /tmp.
    Returns: Presigned URL (str) or None if failed.
    """
    # Use /tmp for ephemeral storage (safe for Lambda/Containers)
    output_folder = "/tmp" 
    output_filename = f"QA_Insights_Report_{sid}.pdf"
    chart_filename = f"category_scores_chart_{sid}.png"
    
    output_path = os.path.join(output_folder, output_filename)
    chart_path = os.path.join(output_folder, chart_filename)

    try:
        # --- A. Generate Chart ---
        generate_horizontal_bar_chart(json_evaluation.get("Categories_Score", {}), chart_path)

        # --- B. Build PDF Document ---
        doc = SimpleDocTemplate(output_path, pagesize=A4)
        elements = []
        styles = getSampleStyleSheet()
        
        # Custom Styles
        styles.add(ParagraphStyle(name='CustomTitle', fontSize=16, leading=20, spaceAfter=12, textColor=colors.darkblue))
        styles.add(ParagraphStyle(name='SectionHeader', fontSize=13, leading=16, spaceAfter=8, textColor=colors.blue))
        styles.add(ParagraphStyle(name='Body', fontSize=10, leading=14))
        cell_style = ParagraphStyle(name='TableCell', fontSize=10, leading=12, spaceAfter=2)

        # Content: Title & Time
        elements.append(Paragraph("<b>Call Simulation Evaluation Report</b>", styles['CustomTitle']))
        elements.append(Spacer(1, 10))
        elements.append(Paragraph(f"<b>Report Generated:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Body']))
        elements.append(Spacer(1, 10))

        # Content: Score
        overall_score = float(json_evaluation.get("Overall_Score", "0%").replace("%", ""))
        status = "PASS" if overall_score >= 80 else "FAIL"
        status_color = "green" if status == "PASS" else "red"
        
        elements.append(Paragraph(f"<b>Overall Score:</b> {overall_score}%", styles['Body']))
        elements.append(Paragraph(f"<b>Status:</b> <font color='{status_color}'><b>{status}</b></font>", styles['Body']))
        elements.append(Spacer(1, 12))

        # Content: Chart Image
        if os.path.exists(chart_path):
            elements.append(Image(chart_path, width=480, height=280))
            elements.append(Spacer(1, 12))

        # Content: Detailed Table
        for section, data in json_evaluation.items():
            if isinstance(data, dict) and "sub_parameters" in data:
                elements.append(Paragraph(f"<b>{section}</b>", styles['SectionHeader']))
                table_data = [["Description"]]
                for sub in data["sub_parameters"]:
                    table_data.append([Paragraph(sub.get("description", ""), cell_style)])

                table = Table(table_data, colWidths=[460])
                table.setStyle(TableStyle([
                    ("BACKGROUND", (0, 0), (-1, 0), colors.lightblue),
                    ("TEXTCOLOR", (0, 0), (-1, 0), colors.whitesmoke),
                    ("ALIGN", (0, 0), (-1, -1), "LEFT"),
                    ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
                    ("BOTTOMPADDING", (0, 0), (-1, 0), 6),
                    ("BACKGROUND", (0, 1), (-1, -1), colors.beige),
                    ("GRID", (0, 0), (-1, -1), 0.25, colors.gray),
                ]))
                elements.append(table)
                elements.append(Spacer(1, 12))

        # Content: Recommendations
        if "Recommendation" in json_evaluation:
            elements.append(Paragraph("<b>Recommendations</b>", styles['SectionHeader']))
            for rec in json_evaluation["Recommendation"]:
                elements.append(Paragraph(f"â€¢ {rec}", styles['Body']))
            elements.append(Spacer(1, 10))

        # Write PDF to /tmp
        doc.build(elements)

        # --- C. Upload to S3 ---
        s3_final_name = f"QA_insights_report_{sid}.pdf"
        success, result = upload_pdf_to_s3(output_path, s3_final_name)
        
        if success:
            return result # This is the Presigned URL
        else:
            print(f"Failed to return URL. Error: {result}")
            return None

    except Exception as e:
        print(f"CRITICAL ERROR in PDF Generation: {str(e)}")
        import traceback
        traceback.print_exc()
        return None

    finally:
        # --- D. Cleanup (Always runs) ---
        # Crucial for servers to avoid 'Disk Full' errors
        if os.path.exists(output_path):
            os.remove(output_path)
        if os.path.exists(chart_path):
            os.remove(chart_path)












def upload_pdf_to_s3(local_file_path, s3_filename):
    """
    Uploads PDF and returns the DIRECT (Permanent) URL.
    NOTE: This URL will only work if the bucket is PUBLIC or the user has direct AWS access.
    """
    bucket_name = configuration['S3']['bucket_name']
    region = configuration['S3']['region']
    folder_prefix = configuration['S3']['folder_prefix']
    
    # Initialize Client (Still need region for upload to work correctly)
    s3_client = boto3.client('s3', region_name=region)

    try:
        s3_key = f"{folder_prefix}{s3_filename}"
        
        # 1. Upload File
        s3_client.upload_file(
            local_file_path,
            bucket_name,
            s3_key,
            ExtraArgs={
                'ContentType': 'application/pdf',
                'ContentDisposition': 'attachment' # Still good to keep
            }
        )
        
        # 2. Construct Direct URL (Traditional Way)
        # Format: https://{bucket}.s3.{region}.amazonaws.com/{key}
        direct_url = f"https://{bucket_name}.s3.{region}.amazonaws.com/{s3_key}"
        
        print(f"[S3] Upload successful. Direct URL: {direct_url}")
        return True, direct_url

    except ClientError as e:
        print(f"[S3 ERROR] {e}")
        return False, str(e)
