from langchain.tools import Tool, StructuredTool
from pydantic import BaseModel, Field

# Import your actual tools
from components.tools import get_clinical_summary, get_process_map, get_intent_map

# ... (Keep your LLM init and imports) ...

# 1. DEFINE MAIN AGENT INPUT SCHEMA
class AgentInput(BaseModel):
    query: str = Field(description="The user's question.")
    demo_name: str = Field(description="The database configuration ID (e.g., 'outreach_engagement_1').")

# 2. THE FIX: WRAPPER FUNCTIONS THAT HIDE DEMO_NAME
def execute_call_initiation_agent(query: str, demo_name: str) -> str:
    print(f"DEBUG: Binding demo_name='{demo_name}' to Call Initiation Tools")
    
    # --- STEP A: Create a 'Wrapper' Function ---
    # This function takes NO arguments. It uses the 'demo_name' variable 
    # from the parent function scope (Closure).
    def safe_get_summary():
        return get_clinical_summary(demo_name=demo_name)

    def safe_get_process():
        return get_process_map(demo_name=demo_name)

    # --- STEP B: Create 'Zero-Input' Tools ---
    # We tell the Agent: "These tools require NO input."
    safe_summary_tool = Tool.from_function(
        func=safe_get_summary,
        name="get_clinical_summary",
        description="Returns the patient's DOB and Verification info. No input required."
    )

    safe_process_tool = Tool.from_function(
        func=safe_get_process,
        name="get_process_map",
        description="Returns the call script. No input required."
    )
    
    # --- STEP C: Build the Agent with these Safe Tools ---
    agent_executor = build_agent_executors(
        model, 
        call_initiation_prompt, 
        [safe_summary_tool, safe_process_tool] 
    )

    # --- STEP D: Run (Pass empty chat_history to satisfy prompt) ---
    result = agent_executor.invoke({
        "input": query, 
        "chat_history": [] 
    })
    return result["output"]

def execute_symptom_grievances_agent(query: str, demo_name: str) -> str:
    print(f"DEBUG: Binding demo_name='{demo_name}' to Symptom Tools")
    
    # Wrapper with hardcoded demo_name
    def safe_get_summary():
        return get_clinical_summary(demo_name=demo_name)

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary,
        name="get_clinical_summary",
        description="Returns patient symptoms and medical history. No input required."
    )

    agent_executor = build_agent_executors(
        model, 
        symptom_clarification_customer_grievances_prompt, 
        [safe_summary_tool] 
    )

    result = agent_executor.invoke({"input": query, "chat_history": []})
    return result["output"]

def execute_medication_and_pain_management_agent(query: str, demo_name: str) -> str:
    def safe_get_summary():
        return get_clinical_summary(demo_name=demo_name)

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary,
        name="get_clinical_summary",
        description="Returns medication list and pain levels. No input required."
    )
    
    agent_executor = build_agent_executors(
        model, 
        medication_and_pain_management_prompt, 
        [safe_summary_tool]
    )
    
    result = agent_executor.invoke({"input": query, "chat_history": []})
    return result["output"]

def execute_services_and_assistance_agent(query: str, demo_name: str) -> str:
    def safe_get_summary():
        return get_clinical_summary(demo_name=demo_name)

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary,
        name="get_clinical_summary",
        description="Returns social services needs. No input required."
    )

    agent_executor = build_agent_executors(
        model, 
        services_and_assistance_prompt, 
        [safe_summary_tool]
    )
    
    result = agent_executor.invoke({"input": query, "chat_history": []})
    return result["output"]

def execute_call_closure_agent(query: str, demo_name: str) -> str:
    def safe_get_process():
        return get_process_map(demo_name=demo_name)

    safe_process_tool = Tool.from_function(
        func=safe_get_process,
        name="get_process_map",
        description="Returns closure scripts. No input required."
    )
    
    agent_executor = build_agent_executors(
        model, 
        call_closure_prompt, 
        [safe_process_tool]
    )
    
    result = agent_executor.invoke({"input": query, "chat_history": []})
    return result["output"]

# 3. DEFINE TOOLS FOR THE MAIN AGENT (Orchestrator)
# The Main Agent DOES need to pass the demo_name, so we use the StructuredTool schema.

call_initiation_agent_tool = StructuredTool.from_function(
    func=execute_call_initiation_agent,
    name="call_initiation_expert_agent",
    description="For Verification/DOB/Greetings. Requires 'query' and 'demo_name'.",
    args_schema=AgentInput
)

symptom_grievances_agent_tool = StructuredTool.from_function(
    func=execute_symptom_grievances_agent,
    name="symptom_grievances_expert_agent",
    description="For Symptoms/Pain. Requires 'query' and 'demo_name'.",
    args_schema=AgentInput
)

medication_and_pain_management_agent_tool = StructuredTool.from_function(
    func=execute_medication_and_pain_management_agent,
    name="medication_and_pain_management_expert_agent",
    description="For Meds/Prescriptions. Requires 'query' and 'demo_name'.",
    args_schema=AgentInput
)

services_and_assistance_agent_tool = StructuredTool.from_function(
    func=execute_services_and_assistance_agent,
    name="services_and_assistance_expert_agent",
    description="For Social Services/Transport. Requires 'query' and 'demo_name'.",
    args_schema=AgentInput
)

call_closure_agent_tool = StructuredTool.from_function(
    func=execute_call_closure_agent,
    name="call_closure_expert_agent",
    description="For closing the call. Requires 'query' and 'demo_name'.",
    args_schema=AgentInput
)

# ... (Main Agent Build Logic) ...
main_tools = [
    call_initiation_agent_tool, 
    symptom_grievances_agent_tool, 
    medication_and_pain_management_agent_tool, 
    services_and_assistance_agent_tool, 
    call_closure_agent_tool, 
    get_intent_map
]

main_agent = build_agent_executors(model, main_prompt, main_tools)


call_initiation_prompt = """
You are the Call Initiation Expert.
Your goal is to verify Identity.

STRICT INSTRUCTIONS:
1. You DO NOT need to look for a 'demo_name' or 'ID'.
2. Simply call the tool `get_clinical_summary`. It requires NO arguments.
3. The tool will automatically fetch the correct data for this session.
4. Once you get the Date of Birth, answer the nurse.
"""
