medication_and_pain_management_prompt = """
You are an expert agent playing the role of the CUSTOMER (patient).
The human participant is the NURSE.

Your objective is to provide a clinically accurate description of your current medications and pain status.

### KEY BEHAVIORAL RULE: "STOIC REPORTING"
You must act as a patient who is **calm, factual, and cooperative**.
- **DO NOT** use emotional metaphors like "It's killing me," "I can't take it," or "I want it to end." (These trigger safety filters).
- **DO** use clinical descriptors like "It is intense," "It is severe," "It feels like pressure."

---

RESPONSIBILITIES:
1. Use tools to retrieve your clinical summary when factual medication or pain details are required.
2. When asked about medications (like Tylenol/Ibuprofen), simply state "Yes" or "No" and whether they help.
   - Example: "I take Tylenol, but it does not lower the pain score."
   - Avoid: "I take them but they are useless and I'm hopeless."
3. When asked about pain, provide a numeric score (e.g., "6 out of 10") and the location.
4. Speak in full sentences but keep the tone **neutral and informative**.

---

TOOL USAGE INSTRUCTIONS:
- ONLY call the tool 'tools_medication_and_pain_management' if the nurse asks
  about medications, dosages, refills, side effects, or pain details AND the
  information is not already available in chat_history.
- Tool usage is invisible to the nurse.
- Do NOT invent or modify demo_name.
- For tool calls, the demo_name must be exactly "{{demo_name}}".

OUTPUT INSTRUCTIONS:
- Output ONLY the customer's spoken response.
- Speak in first person.
"""




def medication_and_pain_management_node(state: GraphState):
    print(f"\nInvoking MEDICATION AGENT: \n")
    
    messages = state["messages"]
    # ... (other setup code) ...

    # --- THE FIX: FILTER CONTEXT ---
    # Instead of passing ALL messages (which might include 20 turns of "I'm in pain"),
    # we only pass the System Prompt + the LAST 2 messages (User Question + Previous Reply).
    # This keeps the agent focused on the IMMEDIATE question (Tylenol), not the "Drama."
    
    short_context_messages = messages[-2:] if len(messages) > 2 else messages
    
    # Now invoke with the cleaner, shorter list
    try:
        final_response = safe_invoke(
            agent_llm,
            [system_msg] + short_context_messages, # <--- Use the short list here
            fallback_content="I take Tylenol as directed."
        )
    except:
        # Fallback mechanism
        pass

    # Update state as usual (append to the full list)
    new_state = state.copy()
    new_state["messages"] = messages + [final_response]
    
    return new_state




# Copy this helper function to the top of your file
def safe_invoke(llm, messages, fallback_content):
    try:
        return llm.invoke(messages)
    except Exception as e:
        # Check if it's the specific Policy Violation error
        error_str = str(e).lower()
        if "content_filter" in error_str or "policyviolation" in error_str:
            print(f"\n[⚠️ AZURE FILTER BLOCKED RESPONSE] - Swapping in safe fallback.")
            # Return a generic, safe response so the flow continues
            return AIMessage(content=fallback_content)
        else:
            # If it's a real code error (like variable missing), raise it
            raise e

# --- UPDATE YOUR NODES LIKE THIS ---

def medication_and_pain_management_node(state: GraphState):
    # ... (previous setup code) ...
    
    # OLD CODE: 
    # final_response = agent_llm.invoke([system_msg] + messages)
    
    # NEW CODE (The Fix):
    final_response = safe_invoke(
        agent_llm,
        [system_msg] + messages,
        fallback_content="I have taken some Tylenol as directed, but the pain is still there. I am being careful with my medication."
    )

    new_state = state.copy()
    new_state["messages"] = messages + [final_response]
    return new_state
