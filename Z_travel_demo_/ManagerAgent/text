from functools import partial
from typing import Dict, Any, Union
from langchain.tools import Tool, StructuredTool
from pydantic import BaseModel, Field
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder, SystemMessagePromptTemplate
from langchain.agents import AgentExecutor, create_tool_calling_agent
from components.prompts import *
from components.llm import Llm
from components.tools import get_clinical_summary, get_process_map, get_intent_map

# LLM Initialization
obj_llm = Llm()
model = obj_llm.model

# --- 1. FLEXIBLE INPUT SCHEMA ---
# The LLM might pass a String OR a Dictionary. We accept both to prevent crashes.
class AgentInput(BaseModel):
    query: str = Field(description="The user's query.")
    demo_name: str = Field(description="The configuration ID (e.g., 'outreach_engagement_1').")
    customer_details: Union[dict, str] = Field(
        description="The FULL customer_details dictionary from your state."
    )

# --- 2. PROMPT BUILDING ---
def build_agent_executors(llm_model, prompt_val, tools_list):
    prompt_template = ChatPromptTemplate.from_messages([
        SystemMessagePromptTemplate.from_template(prompt_val), 
        MessagesPlaceholder(variable_name="chat_history"),
        ("human", "{input}"),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    
    agent_template = create_tool_calling_agent(llm=llm_model, tools=tools_list, prompt=prompt_template)
    
    return AgentExecutor(
        agent=agent_template, 
        tools=tools_list, 
        verbose=True, 
        handle_parsing_errors=True
    )

# --- 3. HELPER: ENSURE STRING FORMAT ---
def ensure_string(details: Union[dict, str]) -> str:
    """Converts dict to string if necessary, handling the Pydantic input flexibility."""
    if isinstance(details, dict):
        return str(details)
    return details

# --- 4. EXECUTION FUNCTIONS ---

def execute_call_initiation_agent(query: str, demo_name: str, customer_details: Union[dict, str]) -> str:
    # Convert dict -> string for the Prompt
    details_str = ensure_string(customer_details)
    
    # Safe Tools
    def safe_get_summary(x=None): return get_clinical_summary.invoke({"demo_name": demo_name})
    def safe_get_process(x=None): return get_process_map.invoke({"demo_name": demo_name})

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary, name="get_clinical_summary",
        description="Returns DB verification info. No input required."
    )
    safe_process_tool = Tool.from_function(
        func=safe_get_process, name="get_process_map",
        description="Returns call script. No input required."
    )

    agent_executor = build_agent_executors(model, call_initiation_prompt, [safe_summary_tool, safe_process_tool])
    
    return agent_executor.invoke({
        "input": query, 
        "chat_history": [],
        "customer_details": details_str, # Passed as String
        "demo_name": demo_name
    })["output"]

def execute_symptom_grievances_agent(query: str, demo_name: str, customer_details: Union[dict, str]) -> str:
    details_str = ensure_string(customer_details)

    def safe_get_summary(x=None): return get_clinical_summary.invoke({"demo_name": demo_name})

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary, name="get_clinical_summary",
        description="Returns clinical history. No input required."
    )

    agent_executor = build_agent_executors(model, symptom_clarification_customer_grievances_prompt, [safe_summary_tool])
    
    return agent_executor.invoke({
        "input": query, 
        "chat_history": [],
        "customer_details": details_str,
        "demo_name": demo_name
    })["output"]

def execute_medication_and_pain_management_agent(query: str, demo_name: str, customer_details: Union[dict, str]) -> str:
    details_str = ensure_string(customer_details)

    def safe_get_summary(x=None): return get_clinical_summary.invoke({"demo_name": demo_name})

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary, name="get_clinical_summary",
        description="Returns meds/pain info. No input required."
    )

    agent_executor = build_agent_executors(model, medication_and_pain_management_prompt, [safe_summary_tool])
    
    return agent_executor.invoke({
        "input": query, 
        "chat_history": [],
        "customer_details": details_str,
        "demo_name": demo_name
    })["output"]

def execute_services_and_assistance_agent(query: str, demo_name: str, customer_details: Union[dict, str]) -> str:
    details_str = ensure_string(customer_details)

    def safe_get_summary(x=None): return get_clinical_summary.invoke({"demo_name": demo_name})

    safe_summary_tool = Tool.from_function(
        func=safe_get_summary, name="get_clinical_summary",
        description="Returns social services info. No input required."
    )

    agent_executor = build_agent_executors(model, services_and_assistance_prompt, [safe_summary_tool])
    
    return agent_executor.invoke({
        "input": query, 
        "chat_history": [],
        "customer_details": details_str,
        "demo_name": demo_name
    })["output"]

def execute_call_closure_agent(query: str, demo_name: str, customer_details: Union[dict, str]) -> str:
    details_str = ensure_string(customer_details)

    def safe_get_process(x=None): return get_process_map.invoke({"demo_name": demo_name})

    safe_process_tool = Tool.from_function(
        func=safe_get_process, name="get_process_map",
        description="Returns closure scripts. No input required."
    )

    agent_executor = build_agent_executors(model, call_closure_prompt, [safe_process_tool])
    
    return agent_executor.invoke({
        "input": query, 
        "chat_history": [],
        "customer_details": details_str,
        "demo_name": demo_name
    })["output"]

# --- 5. MAIN AGENT TOOLS ---

call_initiation_agent_tool = StructuredTool.from_function(
    func=execute_call_initiation_agent,
    name="call_initiation_expert_agent",
    description="For Verification/DOB/Name. Requires 'query', 'demo_name', and 'customer_details'.",
    args_schema=AgentInput
)

symptom_grievances_agent_tool = StructuredTool.from_function(
    func=execute_symptom_grievances_agent,
    name="symptom_grievances_expert_agent",
    description="For Symptoms/Pain. Requires 'query', 'demo_name', and 'customer_details'.",
    args_schema=AgentInput
)

medication_and_pain_management_agent_tool = StructuredTool.from_function(
    func=execute_medication_and_pain_management_agent,
    name="medication_and_pain_management_expert_agent",
    description="For Meds/Prescriptions. Requires 'query', 'demo_name', and 'customer_details'.",
    args_schema=AgentInput
)

services_and_assistance_agent_tool = StructuredTool.from_function(
    func=execute_services_and_assistance_agent,
    name="services_and_assistance_expert_agent",
    description="For Social Services/Transport. Requires 'query', 'demo_name', and 'customer_details'.",
    args_schema=AgentInput
)

call_closure_agent_tool = StructuredTool.from_function(
    func=execute_call_closure_agent,
    name="call_closure_expert_agent",
    description="For Call End. Requires 'query', 'demo_name', and 'customer_details'.",
    args_schema=AgentInput
)

main_tools = [
    call_initiation_agent_tool, symptom_grievances_agent_tool, 
    medication_and_pain_management_agent_tool, services_and_assistance_agent_tool, 
    call_closure_agent_tool, get_intent_map
]

main_agent = build_agent_executors(model, main_prompt, main_tools)
