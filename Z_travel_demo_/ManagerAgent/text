def upload_pdf_to_s3(local_file_path, s3_filename):
    """
    Uploads file and returns a temporary accessible URL (Presigned URL)
    """
    bucket_name = configuration['S3']['bucket_name']
    folder_prefix = configuration['S3']['folder_prefix']
    
    # Initialize S3 client (Automatically picks up IAM Role on server, or local keys on laptop)
    s3_client = boto3.client('s3')
    
    try:
        s3_key = f"{folder_prefix}{s3_filename}"
        
        # 1. Upload the file
        s3_client.upload_file(
            local_file_path,
            bucket_name,
            s3_key,
            ExtraArgs={'ContentType': 'application/pdf'}
        )
        
        # 2. Generate Presigned URL (Valid for 1 hour = 3600 seconds)
        # The frontend can use this link immediately to download the file
        presigned_url = s3_client.generate_presigned_url(
            'get_object',
            Params={'Bucket': bucket_name, 'Key': s3_key},
            ExpiresIn=3600 
        )
        
        print(f"[S3] Upload successful. Generated URL.")
        return True, presigned_url

    except ClientError as e:
        print(f"[S3 ERROR] {e}")
        return False, str(e)

def generate_pdf_report(json_evaluation, sid):
    output_folder = "/tmp"
    output_filename = f"QA_Insights_Report_{sid}.pdf"
    chart_filename = f"category_scores_chart_{sid}.png"
    
    output_path = os.path.join(output_folder, output_filename)
    chart_path = os.path.join(output_folder, chart_filename)

    try:
        # 1. Generate Chart
        generate_horizontal_bar_chart(json_evaluation.get("Categories_Score", {}), chart_path)
        
        # 2. Build PDF (Same logic as your original code)
        doc = SimpleDocTemplate(output_path, pagesize=A4)
        elements = []
        # ... [Your existing code to add paragraphs, tables, and the chart image] ...
        # (Make sure to use 'chart_path' when adding the image)
        
        # Placeholder for your existing PDF element building logic:
        # elements.append(Image(chart_path, width=480, height=280)) 
        
        doc.build(elements)

        # 3. Upload to S3
        s3_filename = f"QA_insights_report_{sid}.pdf" # Clean filename
        success, result = upload_pdf_to_s3(output_path, s3_filename)
        
        if success:
            return result # This is the URL
        else:
            return None

    except Exception as e:
        print(f"Error generating PDF: {e}")
        return None
        
    finally:
        # 4. CLEANUP: Always remove files, even if error occurs
        if os.path.exists(output_path):
            os.remove(output_path)
        if os.path.exists(chart_path):
            os.remove(chart_path)




@app.post(f"{configuration['api_url']['demo_url']}/evaluate")
async def evaluate(query: ReportQuery):
    try:
        # ... [Your existing logic to load params, generate report, calc scores] ...
        
        # (Assume 'report' dictionary is now ready and contains scores)
        
        # --- NEW CODE START ---
        
        # Determine Session ID (use dummy if direct history)
        sid_for_file = query.session_id if query.session_id else f"manual_{datetime.now().strftime('%H%M%S')}"

        # Generate PDF and get URL
        print("Generating PDF Report...")
        pdf_url = generate_pdf_report(report, sid_for_file)
        
        if pdf_url:
            report['pdf_report_url'] = pdf_url
        else:
            report['pdf_report_url'] = "Error: Could not generate report"
            
        # --- NEW CODE END ---

        return jsonable_encoder(report)

    except Exception as e:
        # ... [Your error handling] ...
